import { BaseLoginProvider } from '../entities/base-login-provider';
import { SocialUser } from '../entities/social-user';
import { EventEmitter } from '@angular/core';
import { BehaviorSubject, filter, skip, take } from 'rxjs';
const defaultInitOptions = {
    oneTapEnabled: true,
};
export class GoogleLoginProvider extends BaseLoginProvider {
    constructor(clientId, initOptions) {
        super();
        this.clientId = clientId;
        this.initOptions = initOptions;
        this.changeUser = new EventEmitter();
        this._socialUser = new BehaviorSubject(null);
        this._accessToken = new BehaviorSubject(null);
        this._receivedAccessToken = new EventEmitter();
        this.initOptions = { ...defaultInitOptions, ...this.initOptions };
        // emit changeUser events but skip initial value from behaviorSubject
        this._socialUser.pipe(skip(1)).subscribe(this.changeUser);
        // emit receivedAccessToken but skip initial value from behaviorSubject
        this._accessToken.pipe(skip(1)).subscribe(this._receivedAccessToken);
    }
    initialize(autoLogin) {
        return new Promise((resolve, reject) => {
            try {
                this.loadScript(GoogleLoginProvider.PROVIDER_ID, 'https://accounts.google.com/gsi/client', () => {
                    google.accounts.id.initialize({
                        client_id: this.clientId,
                        auto_select: autoLogin,
                        callback: ({ credential }) => {
                            const socialUser = this.createSocialUser(credential);
                            this._socialUser.next(socialUser);
                        },
                        prompt_parent_id: this.initOptions?.prompt_parent_id,
                        itp_support: this.initOptions.oneTapEnabled
                    });
                    if (this.initOptions.oneTapEnabled) {
                        this._socialUser
                            .pipe(filter((user) => user === null))
                            .subscribe(() => google.accounts.id.prompt(console.debug));
                    }
                    if (this.initOptions.scopes) {
                        const scope = this.initOptions.scopes instanceof Array
                            ? this.initOptions.scopes.filter((s) => s).join(' ')
                            : this.initOptions.scopes;
                        this._tokenClient = google.accounts.oauth2.initTokenClient({
                            client_id: this.clientId,
                            scope,
                            callback: (tokenResponse) => {
                                if (tokenResponse.error) {
                                    this._accessToken.error({
                                        code: tokenResponse.error,
                                        description: tokenResponse.error_description,
                                        uri: tokenResponse.error_uri,
                                    });
                                }
                                else {
                                    this._accessToken.next(tokenResponse.access_token);
                                }
                            },
                        });
                    }
                    resolve();
                });
            }
            catch (err) {
                reject(err);
            }
        });
    }
    getLoginStatus() {
        return new Promise((resolve, reject) => {
            if (this._socialUser.value) {
                resolve(this._socialUser.value);
            }
            else {
                reject(`No user is currently logged in with ${GoogleLoginProvider.PROVIDER_ID}`);
            }
        });
    }
    refreshToken() {
        return new Promise((resolve, reject) => {
            google.accounts.id.revoke(this._socialUser.value.id, (response) => {
                if (response.error)
                    reject(response.error);
                else
                    resolve(this._socialUser.value);
            });
        });
    }
    getAccessToken() {
        return new Promise((resolve, reject) => {
            if (!this._tokenClient) {
                if (this._socialUser.value) {
                    reject('No token client was instantiated, you should specify some scopes.');
                }
                else {
                    reject('You should be logged-in first.');
                }
            }
            else {
                this._tokenClient.requestAccessToken({
                    hint: this._socialUser.value?.email,
                });
                this._receivedAccessToken.pipe(take(1)).subscribe(resolve);
            }
        });
    }
    revokeAccessToken() {
        return new Promise((resolve, reject) => {
            if (!this._tokenClient) {
                reject('No token client was instantiated, you should specify some scopes.');
            }
            else if (!this._accessToken.value) {
                reject('No access token to revoke');
            }
            else {
                google.accounts.oauth2.revoke(this._accessToken.value, () => {
                    this._accessToken.next(null);
                    resolve();
                });
            }
        });
    }
    signIn() {
        return Promise.reject('You should not call this method directly for Google, use "<asl-google-signin-button>" wrapper ' +
            'or generate the button yourself with "google.accounts.id.renderButton()" ' +
            '(https://developers.google.com/identity/gsi/web/guides/display-button#javascript)');
    }
    async signOut() {
        google.accounts.id.disableAutoSelect();
        this._socialUser.next(null);
    }
    createSocialUser(idToken) {
        const user = new SocialUser();
        user.idToken = idToken;
        const payload = this.decodeJwt(idToken);
        user.id = payload.sub;
        user.name = payload.name;
        user.email = payload.email;
        user.photoUrl = payload.picture;
        user.firstName = payload['given_name'];
        user.lastName = payload['family_name'];
        return user;
    }
    decodeJwt(idToken) {
        const base64Url = idToken.split(".")[1];
        const base64 = base64Url.replace(/-/g, "+").replace(/_/g, "/");
        const jsonPayload = decodeURIComponent(window.atob(base64)
            .split("")
            .map(function (c) {
            return "%" + ("00" + c.charCodeAt(0).toString(16)).slice(-2);
        })
            .join(""));
        return JSON.parse(jsonPayload);
    }
}
GoogleLoginProvider.PROVIDER_ID = 'GOOGLE';
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZ29vZ2xlLWxvZ2luLXByb3ZpZGVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vcHJvamVjdHMvbGliL3NyYy9wcm92aWRlcnMvZ29vZ2xlLWxvZ2luLXByb3ZpZGVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxpQkFBaUIsRUFBRSxNQUFNLGlDQUFpQyxDQUFDO0FBQ3BFLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSx5QkFBeUIsQ0FBQztBQUNyRCxPQUFPLEVBQUUsWUFBWSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQzdDLE9BQU8sRUFBRSxlQUFlLEVBQUUsTUFBTSxFQUFFLElBQUksRUFBRSxJQUFJLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFpQjNELE1BQU0sa0JBQWtCLEdBQXNCO0lBQzVDLGFBQWEsRUFBRSxJQUFJO0NBQ3BCLENBQUM7QUFFRixNQUFNLE9BQU8sbUJBQW9CLFNBQVEsaUJBQWlCO0lBVXhELFlBQ1UsUUFBZ0IsRUFDUCxXQUErQjtRQUVoRCxLQUFLLEVBQUUsQ0FBQztRQUhBLGFBQVEsR0FBUixRQUFRLENBQVE7UUFDUCxnQkFBVyxHQUFYLFdBQVcsQ0FBb0I7UUFUbEMsZUFBVSxHQUFHLElBQUksWUFBWSxFQUFxQixDQUFDO1FBRWxELGdCQUFXLEdBQUcsSUFBSSxlQUFlLENBQW9CLElBQUksQ0FBQyxDQUFDO1FBQzNELGlCQUFZLEdBQUcsSUFBSSxlQUFlLENBQWdCLElBQUksQ0FBQyxDQUFDO1FBQ3hELHlCQUFvQixHQUFHLElBQUksWUFBWSxFQUFVLENBQUM7UUFTakUsSUFBSSxDQUFDLFdBQVcsR0FBRyxFQUFFLEdBQUcsa0JBQWtCLEVBQUUsR0FBRyxJQUFJLENBQUMsV0FBVyxFQUFFLENBQUM7UUFFbEUscUVBQXFFO1FBQ3JFLElBQUksQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxJQUFJLENB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SSxDQUFDLEtBQUssQ0FBQyxXQUFXLENBQUMsQ0FBQztJQUNqQyxDQUFDOztBQS9Lc0IsK0JBQVcsR0FBVyxRQUFRLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBCYXNlTG9naW5Qcm92aWRlciB9IGZyb20gJy4uL2VudGl0aWVzL2Jhc2UtbG9naW4tcHJvdmlkZXInO1xyXG5pbXBvcnQgeyBTb2NpYWxVc2VyIH0gZnJvbSAnLi4vZW50aXRpZXMvc29jaWFsLXVzZXInO1xyXG5pbXBvcnQgeyBFdmVudEVtaXR0ZXIgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcclxuaW1wb3J0IHsgQmVoYXZpb3JTdWJqZWN0LCBmaWx0ZXIsIHNraXAsIHRha2UgfSBmcm9tICdyeGpzJztcclxuXHJcbmV4cG9ydCBpbnRlcmZhY2UgR29vZ2xlSW5pdE9wdGlvbnMge1xyXG4gIC8qKlxyXG4gICAqIGVuYWJsZXMgdGhlIE9uZSBUYXAgbWVjaGFuaXNtLCBhbmQgbWFrZXMgYXV0by1sb2dpbiBwb3NzaWJsZVxyXG4gICAqL1xyXG4gIG9uZVRhcEVuYWJsZWQ/OiBib29sZWFuO1xyXG4gIC8qKlxyXG4gICAqIGxpc3Qgb2YgcGVybWlzc2lvbiBzY29wZXMgdG8gZ3JhbnQgaW4gY2FzZSB3ZSByZXF1ZXN0IGFuIGFjY2VzcyB0b2tlblxyXG4gICAqL1xyXG4gIHNjb3Blcz86IHN0cmluZyB8IHN0cmluZ1tdO1xyXG4gLyoqXHJcbiAgICogVGhpcyBhdHRyaWJ1dGUgc2V0cyB0aGUgRE9NIElEIG9mIHRoZSBjb250YWluZXIgZWxlbWVudC4gSWYgaXQncyBub3Qgc2V0LCB0aGUgT25lIFRhcCBwcm9tcHQgaXMgZGlzcGxheWVkIGluIHRoZSB0b3AtcmlnaHQgY29ybmVyIG9mIHRoZSB3aW5kb3cuXHJcbiAgICovXHJcbiAgcHJvbXB0X3BhcmVudF9pZD86IHN0cmluZztcclxufVxyXG5cclxuY29uc3QgZGVmYXVsdEluaXRPcHRpb25zOiBHb29nbGVJbml0T3B0aW9ucyA9IHtcclxuICBvbmVUYXBFbmFibGVkOiB0cnVlLFxyXG59O1xyXG5cclxuZXhwb3J0IGNsYXNzIEdvb2dsZUxvZ2luUHJvdmlkZXIgZXh0ZW5kcyBCYXNlTG9naW5Qcm92aWRlciB7XHJcbiAgcHVibGljIHN0YXRpYyByZWFkb25seSBQUk9WSURFUl9JRDogc3RyaW5nID0gJ0dPT0dMRSc7XHJcblxyXG4gIHB1YmxpYyByZWFkb25seSBjaGFuZ2VVc2VyID0gbmV3IEV2ZW50RW1pdHRlcjxTb2NpYWxVc2VyIHwgbnVsbD4oKTtcclxuXHJcbiAgcHJpdmF0ZSByZWFkb25seSBfc29jaWFsVXNlciA9IG5ldyBCZWhhdmlvclN1YmplY3Q8U29jaWFsVXNlciB8IG51bGw+KG51bGwpO1xyXG4gIHByaXZhdGUgcmVhZG9ubHkgX2FjY2Vzc1Rva2VuID0gbmV3IEJlaGF2aW9yU3ViamVjdDxzdHJpbmcgfCBudWxsPihudWxsKTtcclxuICBwcml2YXRlIHJlYWRvbmx5IF9yZWNlaXZlZEFjY2Vzc1Rva2VuID0gbmV3IEV2ZW50RW1pdHRlcjxzdHJpbmc+KCk7XHJcbiAgcHJpdmF0ZSBfdG9rZW5DbGllbnQ6IGdvb2dsZS5hY2NvdW50cy5vYXV0aDIuVG9rZW5DbGllbnQgfCB1bmRlZmluZWQ7XHJcblxyXG4gIGNvbnN0cnVjdG9yKFxyXG4gICAgcHJpdmF0ZSBjbGllbnRJZDogc3RyaW5nLFxyXG4gICAgcHJpdmF0ZSByZWFkb25seSBpbml0T3B0aW9ucz86IEdvb2dsZUluaXRPcHRpb25zXHJcbiAgKSB7XHJcbiAgICBzdXBlcigpO1xyXG5cclxuICAgIHRoaXMuaW5pdE9wdGlvbnMgPSB7IC4uLmRlZmF1bHRJbml0T3B0aW9ucywgLi4udGhpcy5pbml0T3B0aW9ucyB9O1xyXG5cclxuICAgIC8vIGVtaXQgY2hhbmdlVXNlciBldmVudHMgYnV0IHNraXAgaW5pdGlhbCB2YWx1ZSBmcm9tIGJlaGF2aW9yU3ViamVjdFxyXG4gICAgdGhpcy5fc29jaWFsVXNlci5waXBlKHNraXAoMSkpLnN1YnNjcmliZSh0aGlzLmNoYW5nZVVzZXIpO1xyXG5cclxuICAgIC8vIGVtaXQgcmVjZWl2ZWRBY2Nlc3NUb2tlbiBidXQgc2tpcCBpbml0aWFsIHZhbHVlIGZyb20gYmVoYXZpb3JTdWJqZWN0XHJcbiAgICB0aGlzLl9hY2Nlc3NUb2tlbi5waXBlKHNraXAoMSkpLnN1YnNjcmliZSh0aGlzLl9yZWNlaXZlZEFjY2Vzc1Rva2VuKTtcclxuICB9XHJcblxyXG4gIGluaXRpYWxpemUoYXV0b0xvZ2luPzogYm9vbGVhbik6IFByb21pc2U8dm9pZD4ge1xyXG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcclxuICAgICAgdHJ5IHtcclxuICAgICAgICB0aGlzLmxvYWRTY3JpcHQoXHJcbiAgICAgICAgICBHb29nbGVMb2dpblByb3ZpZGVyLlBST1ZJREVSX0lELFxyXG4gICAgICAgICAgJ2h0dHBzOi8vYWNjb3VudHMuZ29vZ2xlLmNvbS9nc2kvY2xpZW50JyxcclxuICAgICAgICAgICgpID0+IHtcclxuICAgICAgICAgICAgZ29vZ2xlLmFjY291bnRzLmlkLmluaXRpYWxpemUoe1xyXG4gICAgICAgICAgICAgIGNsaWVudF9pZDogdGhpcy5jbGllbnRJZCxcclxuICAgICAgICAgICAgICBhdXRvX3NlbGVjdDogYXV0b0xvZ2luLFxyXG4gICAgICAgICAgICAgIGNhbGxiYWNrOiAoeyBjcmVkZW50aWFsIH0pID0+IHtcclxuICAgICAgICAgICAgICAgIGNvbnN0IHNvY2lhbFVzZXIgPSB0aGlzLmNyZWF0ZVNvY2lhbFVzZXIoY3JlZGVudGlhbCk7XHJcbiAgICAgICAgICAgICAgICB0aGlzLl9zb2NpYWxVc2VyLm5leHQoc29jaWFsVXNlcik7XHJcbiAgICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgICBwcm9tcHRfcGFyZW50X2lkOiB0aGlzLmluaXRPcHRpb25zPy5wcm9tcHRfcGFyZW50X2lkLFxyXG4gICAgICAgICAgICAgIGl0cF9zdXBwb3J0OiB0aGlzLmluaXRPcHRpb25zLm9uZVRhcEVuYWJsZWRcclxuICAgICAgICAgICAgfSk7XHJcblxyXG4gICAgICAgICAgICBpZiAodGhpcy5pbml0T3B0aW9ucy5vbmVUYXBFbmFibGVkKSB7XHJcbiAgICAgICAgICAgICAgdGhpcy5fc29jaWFsVXNlclxyXG4gICAgICAgICAgICAgICAgLnBpcGUoZmlsdGVyKCh1c2VyKSA9PiB1c2VyID09PSBudWxsKSlcclxuICAgICAgICAgICAgICAgIC5zdWJzY3JpYmUoKCkgPT4gZ29vZ2xlLmFjY291bnRzLmlkLnByb21wdChjb25zb2xlLmRlYnVnKSk7XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIGlmICh0aGlzLmluaXRPcHRpb25zLnNjb3Blcykge1xyXG4gICAgICAgICAgICAgIGNvbnN0IHNjb3BlID1cclxuICAgICAgICAgICAgICAgIHRoaXMuaW5pdE9wdGlvbnMuc2NvcGVzIGluc3RhbmNlb2YgQXJyYXlcclxuICAgICAgICAgICAgICAgICAgPyB0aGlzLmluaXRPcHRpb25zLnNjb3Blcy5maWx0ZXIoKHMpID0+IHMpLmpvaW4oJyAnKVxyXG4gICAgICAgICAgICAgICAgICA6IHRoaXMuaW5pdE9wdGlvbnMuc2NvcGVzO1xyXG5cclxuICAgICAgICAgICAgICB0aGlzLl90b2tlbkNsaWVudCA9IGdvb2dsZS5hY2NvdW50cy5vYXV0aDIuaW5pdFRva2VuQ2xpZW50KHtcclxuICAgICAgICAgICAgICAgIGNsaWVudF9pZDogdGhpcy5jbGllbnRJZCxcclxuICAgICAgICAgICAgICAgIHNjb3BlLFxyXG4gICAgICAgICAgICAgICAgY2FsbGJhY2s6ICh0b2tlblJlc3BvbnNlKSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgIGlmICh0b2tlblJlc3BvbnNlLmVycm9yKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5fYWNjZXNzVG9rZW4uZXJyb3Ioe1xyXG4gICAgICAgICAgICAgICAgICAgICAgY29kZTogdG9rZW5SZXNwb25zZS5lcnJvcixcclxuICAgICAgICAgICAgICAgICAgICAgIGRlc2NyaXB0aW9uOiB0b2tlblJlc3BvbnNlLmVycm9yX2Rlc2NyaXB0aW9uLFxyXG4gICAgICAgICAgICAgICAgICAgICAgdXJpOiB0b2tlblJlc3BvbnNlLmVycm9yX3VyaSxcclxuICAgICAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLl9hY2Nlc3NUb2tlbi5uZXh0KHRva2VuUmVzcG9uc2UuYWNjZXNzX3Rva2VuKTtcclxuICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgcmVzb2x2ZSgpO1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgICk7XHJcbiAgICAgIH0gY2F0Y2ggKGVycikge1xyXG4gICAgICAgIHJlamVjdChlcnIpO1xyXG4gICAgICB9XHJcbiAgICB9KTtcclxuICB9XHJcblxyXG4gIGdldExvZ2luU3RhdHVzKCk6IFByb21pc2U8U29jaWFsVXNlcj4ge1xyXG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcclxuICAgICAgaWYgKHRoaXMuX3NvY2lhbFVzZXIudmFsdWUpIHtcclxuICAgICAgICByZXNvbHZlKHRoaXMuX3NvY2lhbFVzZXIudmFsdWUpO1xyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIHJlamVjdChcclxuICAgICAgICAgIGBObyB1c2VyIGlzIGN1cnJlbnRseSBsb2dnZWQgaW4gd2l0aCAke0dvb2dsZUxvZ2luUHJvdmlkZXIuUFJPVklERVJfSUR9YFxyXG4gICAgICAgICk7XHJcbiAgICAgIH1cclxuICAgIH0pO1xyXG4gIH1cclxuXHJcbiAgcmVmcmVzaFRva2VuKCk6IFByb21pc2U8U29jaWFsVXNlciB8IG51bGw+IHtcclxuICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XHJcbiAgICAgIGdvb2dsZS5hY2NvdW50cy5pZC5yZXZva2UodGhpcy5fc29jaWFsVXNlci52YWx1ZS5pZCwgKHJlc3BvbnNlKSA9PiB7XHJcbiAgICAgICAgaWYgKHJlc3BvbnNlLmVycm9yKSByZWplY3QocmVzcG9uc2UuZXJyb3IpO1xyXG4gICAgICAgIGVsc2UgcmVzb2x2ZSh0aGlzLl9zb2NpYWxVc2VyLnZhbHVlKTtcclxuICAgICAgfSk7XHJcbiAgICB9KTtcclxuICB9XHJcblxyXG4gIGdldEFjY2Vzc1Rva2VuKCk6IFByb21pc2U8c3RyaW5nPiB7XHJcbiAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xyXG4gICAgICBpZiAoIXRoaXMuX3Rva2VuQ2xpZW50KSB7XHJcbiAgICAgICAgaWYgKHRoaXMuX3NvY2lhbFVzZXIudmFsdWUpIHtcclxuICAgICAgICAgIHJlamVjdChcclxuICAgICAgICAgICAgJ05vIHRva2VuIGNsaWVudCB3YXMgaW5zdGFudGlhdGVkLCB5b3Ugc2hvdWxkIHNwZWNpZnkgc29tZSBzY29wZXMuJ1xyXG4gICAgICAgICAgKTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgcmVqZWN0KCdZb3Ugc2hvdWxkIGJlIGxvZ2dlZC1pbiBmaXJzdC4nKTtcclxuICAgICAgICB9XHJcbiAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgdGhpcy5fdG9rZW5DbGllbnQucmVxdWVzdEFjY2Vzc1Rva2VuKHtcclxuICAgICAgICAgIGhpbnQ6IHRoaXMuX3NvY2lhbFVzZXIudmFsdWU/LmVtYWlsLFxyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIHRoaXMuX3JlY2VpdmVkQWNjZXNzVG9rZW4ucGlwZSh0YWtlKDEpKS5zdWJzY3JpYmUocmVzb2x2ZSk7XHJcbiAgICAgIH1cclxuICAgIH0pO1xyXG4gIH1cclxuXHJcbiAgcmV2b2tlQWNjZXNzVG9rZW4oKTogUHJvbWlzZTx2b2lkPiB7XHJcbiAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xyXG4gICAgICBpZiAoIXRoaXMuX3Rva2VuQ2xpZW50KSB7XHJcbiAgICAgICAgcmVqZWN0KFxyXG4gICAgICAgICAgJ05vIHRva2VuIGNsaWVudCB3YXMgaW5zdGFudGlhdGVkLCB5b3Ugc2hvdWxkIHNwZWNpZnkgc29tZSBzY29wZXMuJ1xyXG4gICAgICAgICk7XHJcbiAgICAgIH0gZWxzZSBpZiAoIXRoaXMuX2FjY2Vzc1Rva2VuLnZhbHVlKSB7XHJcbiAgICAgICAgcmVqZWN0KCdObyBhY2Nlc3MgdG9rZW4gdG8gcmV2b2tlJyk7XHJcbiAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgZ29vZ2xlLmFjY291bnRzLm9hdXRoMi5yZXZva2UodGhpcy5fYWNjZXNzVG9rZW4udmFsdWUsICgpID0+IHtcclxuICAgICAgICAgIHRoaXMuX2FjY2Vzc1Rva2VuLm5leHQobnVsbCk7XHJcbiAgICAgICAgICByZXNvbHZlKCk7XHJcbiAgICAgICAgfSk7XHJcbiAgICAgIH1cclxuICAgIH0pO1xyXG4gIH1cclxuXHJcbiAgc2lnbkluKCk6IFByb21pc2U8U29jaWFsVXNlcj4ge1xyXG4gICAgcmV0dXJuIFByb21pc2UucmVqZWN0KFxyXG4gICAgICAnWW91IHNob3VsZCBub3QgY2FsbCB0aGlzIG1ldGhvZCBkaXJlY3RseSBmb3IgR29vZ2xlLCB1c2UgXCI8YXNsLWdvb2dsZS1zaWduaW4tYnV0dG9uPlwiIHdyYXBwZXIgJyArXHJcbiAgICAgICAgJ29yIGdlbmVyYXRlIHRoZSBidXR0b24geW91cnNlbGYgd2l0aCBcImdvb2dsZS5hY2NvdW50cy5pZC5yZW5kZXJCdXR0b24oKVwiICcgK1xyXG4gICAgICAgICcoaHR0cHM6Ly9kZXZlbG9wZXJzLmdvb2dsZS5jb20vaWRlbnRpdHkvZ3NpL3dlYi9ndWlkZXMvZGlzcGxheS1idXR0b24jamF2YXNjcmlwdCknXHJcbiAgICApO1xyXG4gIH1cclxuXHJcbiAgYXN5bmMgc2lnbk91dCgpOiBQcm9taXNlPHZvaWQ+IHtcclxuICAgIGdvb2dsZS5hY2NvdW50cy5pZC5kaXNhYmxlQXV0b1NlbGVjdCgpO1xyXG4gICAgdGhpcy5fc29jaWFsVXNlci5uZXh0KG51bGwpO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBjcmVhdGVTb2NpYWxVc2VyKGlkVG9rZW46IHN0cmluZykge1xyXG4gICAgY29uc3QgdXNlciA9IG5ldyBTb2NpYWxVc2VyKCk7XHJcbiAgICB1c2VyLmlkVG9rZW4gPSBpZFRva2VuO1xyXG4gICAgY29uc3QgcGF5bG9hZCA9IHRoaXMuZGVjb2RlSnd0KGlkVG9rZW4pO1xyXG4gICAgdXNlci5pZCA9IHBheWxvYWQuc3ViO1xyXG4gICAgdXNlci5uYW1lID0gcGF5bG9hZC5uYW1lO1xyXG4gICAgdXNlci5lbWFpbCA9IHBheWxvYWQuZW1haWw7XHJcbiAgICB1c2VyLnBob3RvVXJsID0gcGF5bG9hZC5waWN0dXJlO1xyXG4gICAgdXNlci5maXJzdE5hbWUgPSBwYXlsb2FkWydnaXZlbl9uYW1lJ107XHJcbiAgICB1c2VyLmxhc3ROYW1lID0gcGF5bG9hZFsnZmFtaWx5X25hbWUnXTtcclxuICAgIHJldHVybiB1c2VyO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBkZWNvZGVKd3QoaWRUb2tlbjogc3RyaW5nKTogUmVjb3JkPHN0cmluZywgc3RyaW5nIHwgdW5kZWZpbmVkPiB7XHJcbiAgICBjb25zdCBiYXNlNjRVcmwgPSBpZFRva2VuLnNwbGl0KFwiLlwiKVsxXTtcclxuICAgIGNvbnN0IGJhc2U2NCA9IGJhc2U2NFVybC5yZXBsYWNlKC8tL2csIFwiK1wiKS5yZXBsYWNlKC9fL2csIFwiL1wiKTtcclxuICAgIGNvbnN0IGpzb25QYXlsb2FkID0gZGVjb2RlVVJJQ29tcG9uZW50KFxyXG4gICAgICB3aW5kb3cuYXRvYihiYXNlNjQpXHJcbiAgICAgICAgLnNwbGl0KFwiXCIpXHJcbiAgICAgICAgLm1hcChmdW5jdGlvbiAoYykge1xyXG4gICAgICAgICAgcmV0dXJuIFwiJVwiICsgKFwiMDBcIiArIGMuY2hhckNvZGVBdCgwKS50b1N0cmluZygxNikpLnNsaWNlKC0yKTtcclxuICAgICAgICB9KVxyXG4gICAgICAgIC5qb2luKFwiXCIpXHJcbiAgICApO1xyXG4gICAgcmV0dXJuIEpTT04ucGFyc2UoanNvblBheWxvYWQpO1xyXG4gIH1cclxufVxyXG4iXX0=